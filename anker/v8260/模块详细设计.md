# 编辑回退设计
- 1.历史记录存储采用容量50的fifo的数据结构
- 2.单条记录数据以fabric.js规则下的json字符串进行保存
- 3.以画布图层元素的增删改作为触发历史保存的动作

这幅图展示了一个历史记录管理的系统，使用**FIFO（先进先出）队列**的概念来处理记录的存储与访问。以下是对图中各个部分及其功能的详细整理和分析：

### 整体结构

- **历史栈（History Stack）**：
  - 这是整个系统提交记录的主体结构，主要用于存储所有的历史记录。

### 图示内容及组件

1. **FIFO 队列**（First In, First Out）：
   - 显示了历史记录的存储顺序。最早添加的记录会在队列的最前面，而新添加的记录会在队列的尾部。
   - 图中展示了50个历史记录，标记为：`History Record 1` 至 `History Record 50`。

2. **新记录的添加**：
   - 当有新记录（`History Record (new record)`）时，它会被添加到队列的尾部。

3. **指针管理**：
   - **指针默认指向当前最新操作**：在新的记录添加后，指针自动跳转到最新的记录位置。这使得访问和管理最新记录更加方便。

4. **用户后退功能**：
   - 用户可以选择后退操作，指针会向前移动以返回到之前操作所指的历史记录。这一功能增加了对记录的访问灵活性，并允许用户返回到之前的状态。

5. **记录替换与插入**：
   - 若在历史记录中添加新记录（`History Record 6`），根据设定，如果当前记录存在，则原有记录将被替换。
   - 这通过改变索引使新记录插入到适当位置，确保数据结构的有序性和完整性。

6. **记录更新**：
   - 显示历史记录更新后的结构，尤其是通过形象的方式展示索引的变化，例如 `6` 变为 `7`，表示更新操作后的记录。

### 操作和管理逻辑
- **数据的插入和更新**：
  - 通过 FIFO 逻辑，系统明确了数据存入和取出的顺序，确保高效的数据操作。
  
- **优先级功能**：
  - 由于引入了后退和覆盖的机制，使得用户在操作记录时可以灵活处理，确保容易访问和管理每一条记录。

### 总结
- 这幅图整体展示了如何利用 FIFO 结构管理历史记录，同时确保记录的添加、更新和用户交互的简单性和有效性。
- 通过这些机制，提升了数据处理的准确性和用户体验，尤其是在需要频繁修改和访问历史记录的应用中。
- 这种结构在实际应用中非常实用，广泛应用于数据管理、版本控制等场景。当理解这些机制和流程之后，开发者能够更好地设计和实现相应的程序结构。

# 4.模块详细设计
## 4.1项目打印
### 4.1.1打印总流程
#### 总数
- 通过在web端操作图文编辑，生成打印项目文件，并通过jsbridge，http，scheme通信渠道传递打印数据给客户端，在通过客户端操作，最终操作设备进行打印
- 发起打印成功率>99.9%
- mac下是基于url scheme协议唤起的，windows下则是基于url的protocol协议的
### 4.1.2整体处理流程
这幅图展示了一个系统的工作流程，涉及到项目的创建、编辑和打印全过程。以下是图中所有内容的详细记录和分析：

### 总体结构
- **图的主题**：展示了从项目创建到打印的完整工作流，是否涉及到配置文件的使用和用户交互。

### 各个部分详细说明

1. **创建项目**：
   - 用户开始创建一个新项目，作为整个工作流程的起点。项目信息，项目底图等等

2. **进入编辑器**：
   - 用户进入图像编辑器，开始对项目进行处理和修改。图片导入的策略，分辨率宽小于1000，图片小雨10m

3. **编辑图像**：
   - 在此步骤中，用户可以对输入的图像进行编辑，调整图像内容：
     - **实时保存**：用户的编辑内容会实时保存以防丢失。

4. **项目背景信息**（左下角注释）：
   - 提供了项目的背景信息，重要数据包含：
     - 项目底图
     - 指引内容：如调整新图形的大小、拆分图形组等。

5. **打印过程**：
   - 编辑完成后，用户可以执行打印操作，生成打印文件：
     - **打印项目文件**：将编辑图像转换为可打印文件。
     - **用户指定的设置**：配置打印参数（如分辨率、输出格式）。
     - 编辑打印数据，生成config。json并且上传，上传白墨光油图片提供给服务器使用
     - 上传打印设置信息的内容
     - config。json数据的内容
     - 1.打印质量，根据打印质量设置dpi，
     - 2.白墨信息
     - 3.光油信息
     - 打印参数信息
     - 1.print mode配置信息，标记在图层信息当中
     - 2.客户端需要信息，幅面长宽等等

6. **打印配置**：
   - 提供关于打印设置的信息，参数包括：
     - **config.json** 文件：
       - 打印配置选项（如 DPI 设置，图像质量等）。
       - 包含的内容：
         1. 打印模式设置。
         2. 其它基本信息。
         3. 打包打印文件，并且上传，的到打印项目链接
         4. 白墨图片，光油图片，打印图片
         5. 打印配置信息，json信息包含打印质量，白墨图片，光油图片等等
         6. 上传压缩包数据
         7. 白墨图片，光油图片，打印图片，config.json，缩略图

7. **输出内容**：
   - 打印结果会生成最终的文件，确保用户能够得到期望的输出。

8. **用户交互部分**（右侧）：
   - 切片软件内嵌的jsbridge唤起，切片软件，选择设备，单个设备跳过
   - 浏览器唤起，scheme，protocol唤起，pc选择设备，单个设备跳过
   - **选择设备**：用户可以选择打印设备，进行打印操作。
   - **预览功能**：在最终打印之前，用户可以预览打印结果以确认和修改。
   - **加入队列**和**立即打印**功能：用户可以选择将当前打印任务添加到打印队列中，或直接进行打印。

10. **连接与流程**：
   - 通过箭头和连接线，展示了各个过程的顺序和流向，强调了操作的逻辑关系。

### 总结
- 本图展示了从项目创建到打印的详尽流程，通过图形化的界面使用户能够直观地理解和管理每一个步骤的执行。
- 系统设计上考虑了用户体验，允许用户灵活地进行输入、编辑和打印，同时也提供了对配置文件和设定的支持，确保操作的可靠性和有效性。
- 这种分步骤的流向设计有助于开发者理解系统的整体架构，从而在设计和实现软件时能更高效地处理用户需求和功能实现。

# 4.1.2-画布选择流程
## 4.1.2.1综述
- 画布选择是2d编辑的第一步，用户可以选择标品和非标品，标品分为5大类，每类里面的各种产品样式，每个产品样式里面包含画布的底图和场景图的信息，非标品只包含了统一的画布底图的信息，只是作画比例不一样的
- 4.1.2.2流程图
以下是对图中每一步的详细描述，确保不遗漏任何关键内容和流程：

### 1. 创建项目
- 用户开始创建一个新项目，为接下来的操作做准备。

### 2. 进入编辑器
- 用户在系统中进入图像编辑器，准备进行图像修改与配置。
- 产品配置画布数据，在cms当中配置数据，参数配置是根据mm转成像素，这里可能会有偏差，1px的偏差需要经过测试验证是否影响

### 3. 获取配置面数据
- 系统从数据库中加载与当前产品相关的配置面数据。这些数据将用于展示和编辑。

### 4. 选择产品类型
- 用户通过界面选择需要处理的产品类型。这一选择是后续操作的基础。

### 5. 选择模板图片
- 用户需要从系统内选择与产品类型相关的模板图片，作为编辑的基础。用户进入编辑器，获取画布数据，选种产品类型，选择画布底图，来创建项目，提示用户，成功的话，的到项目的信息，初始化画布，设置画布的底图更新项目的数据，加载场景图，是否有3d模型，有的话加载3d模型，没有的话加载材质

### 6. 创建项目
- 在选择完模板后，用户执行项目的创建操作，以正式启动该项目的编辑流程。

### 7. 设置或查看详细信息
- 用户在此步骤中，可以设置底图和其他重要的项目属性，更新当前项目的数据。

### 8. 初始配置创建
- 系统根据用户输入的信息进行初始配置生成。

### 9. 判断是否添加 3D 模型
- 系统询问用户是否要添加 3D 模型：
  - **如果选择“是”（true）**：则继续进行 3D 模型的添加操作。
  - **如果选择“否”（false）**：则跳过 3D 模型的添加，直接执行下一步。

### 10. 判断项目类型
- 系统检查当前项目的类型，以确定来自用户的输入类型是否为 3D 模型。

### 11. 获取具体信息
- 系统将获取所有相关的项目细节信息，以确保信息的完整性。

### 12. 更新当前项目
- 此步骤涉及更新现有项目的内容，包括任何变更或新增的信息，将更新后的信息回呈现给用户。

### 13. 重新加载设定
- 在更新项目后，为确保设置的有效性，系统会重新加载所有设定，以允许用户检查效果。

### 14. 提示用户
- 可能会有提示框，提醒用户操作的完成或下一步需要的动作。

### 其他信息
- **参数配置说明**：
  - 注释区域提到参数配置是基于毫米转化，具有准确性问题，需要进行验证以确保有效。
  
- **右侧的附加选项**：
  - 提及用户可以选择打印设备、进行预览、添加到打印队列或立即打印等操作，提供更大的灵活性。
  - 当项目再次创建，根据是否覆盖，如果是的话获取所有的画布详细信息，修改当前项目所有的基础画布的信息，更新项目并且重新绘制画布，false的话重新设置画布渲染数据

### 总结
- 这份详细的流程描述确保覆盖了每一步的关键操作和选择，帮助用户理解整个工作流程。
- 通过这种结构化的环节设计，系统能够有效地管理数据，并提高用户体验，使得各项操作逻辑清晰，易于理解和操作。
- 
- fabric加载图层json，然后加载监听，然后进行版本的判断，如果发现旧版本，则根据版本号修改对旧版本的兼容，false的话根据最新的代码处理，最后的到最后的渲染数据
# 接口设计
- 接口地址：域名+/web/editor/project/create_project
- 传入的参数
- dir_id,integer目录id，0或者不穿表示根目录
- project_name,string项目名称
- project_desc,string项目描述,
- category,integer项目分类，装饰画，钥匙扣，贴纸，手机壳，水杯，枚举值友前端定义
- is——standdard_project，integer,是否标准产品，0非标准产品，1标准产品
- scenes，string场景信息，json格式字符串
- materials，string，材料信息，json格式字符串
- base_map，string底图url
- base_map_width,intger，底图宽度
- base_map_height,intger，底图高度
- 返回参数
- project_id,string，项目id
- project_name,string项目名称
- project_desc,string，项目描述
- category.integer项目分类，装饰画，钥匙扣，贴纸，手机壳水杯，枚举值由前端定义1-100
- is_standard_project,integer是否标准产品
- scenes，string场景信息，json格式字符串
- materials，string，材料信息，json格式字符串
- print_params,syring，打印参数json格式字符串】
- print_flag,integer打印文件标志，0没有生成单音文件，1已经生成打印文件
- base_map，string,底图url
- base_map_width:integer底图的宽度
- base——map_height:integer底图的高度
- create_time,integer创建的时间
- update_time,integer更新时间
- upload——urls,object,ProjectUploadUrls
- project_path,string,项目工程文件上传链接
- thumb_path，string项目缩略图上传链接
- output_path,STRING项目设计图片的上传的链接
- scene——path：string项目场景上传的链接
- print_path:string项目打印文件上传的链接
- share_path，string项目发布文件上传的链接
- public_path，string项目发布文件上传的链接
- download_urls,object,ProjectDownLoadUrls
- project_path     | string  | 项目工程文件下载链接
- thumb_path       | string  | 项目缩略图文件下载链接
- output_path      | string  | 项目设计图片下载链接
- scene_path       | string  | 项目场景图下载链接
- print_path       | string  | 项目打印文件下载链接
- share_path       | string  | 项目分享文件下载链接
- publish_path     | string  | 项目发布文件下载链接   


