### 1.1 灰度化

该步骤是将彩色输入图（RGB）转化为灰度图（gray），其主要的计算公式如下：

\[ \text{gray} = 0.2989 \times r + 0.5870 \times g + 0.1140 \times b \]

其中，r、g、b分别为彩色图三个通道的值，该公式能够得到一个浮点数值的灰度图，相比OpenCV自带类型转换API，因为得到的是整型的灰度值，其计算高度信息的数据值更准确。

**注意**：需要注意的是OpenCV存储的彩色图RGB通道信息顺序是倒序（BGR）。

### 1.2 灰度值转高度值

遍历灰度图像，每个像素点通过如下公式进行高度值转换：

\[ \text{height} = \left( \frac{\text{meshMax}_H - \text{meshMin}_H}{\text{gray}_{\text{max}} - \text{gray}_{\text{min}}} \right) \times (\text{gray}_{\text{value}} - \text{gray}_{\text{min}}) + \text{meshMin}_H \]

其中，Max_H和Min_H为生成的mesh最大最小高度，gray_value为每个像素的灰度值。

得到的高度图通过meshgrid坐标转换，首先先对高度图边界进行0填充，然后构建x、y的坐标网格，并将长度单位缩放为mm，最后构建x、y、z三个vector来存储每个坐标下的数据，构成点云图。

### 1.3 构建triangle mesh

通过构建的点云生成triangle mesh 3D模型。Open3D中，表示三角网格（Triangle Mesh）的主要数据结构是`open3d.geometry.TriangleMesh`。它是由一组相邻的三角形组成的，每个三角形由三个顶点和它们之间的边构成。

**主要属性**：

1. **顶点坐标（Vertices）**：可以通过`vertices`属性获取三角网格的顶点坐标。一个二维数组，每一行包含三维空间中的一个顶点的坐标。
### 1.3 构建triangle mesh（续）

2. **三角形索引（Triangles）**：可以通过`triangles`属性获取三角网格的三角形索引。这是一个二维数组，每一行包含一个三角形的三个顶点索引，这些索引对应于`vertices`属性中的顶点。

3. **法线（Normals）**：可以通过`normals`属性获取三角网格的法线。法线用于表征三角形的朝向，有助于光照和渲染效果。

#### 示例图解

遍历meshgrid坐标系，每个 \((i, j)\) 坐标生成六个顶点，构成两个三角形，如下图所示：

```
(i, j)    (i, j+1)
   *--------*
   |      / |
   |    /   |
   |  /     |
   *--------*
(i+1, j)  (i+1, j+1)
```

三角形索引表示为：
\[ [(i, j), (i, j+1), (i+1, j)], [(i, j+1), (i+1, j+1), (i+1, j)] \]

遍历完整的meshgrid坐标系后，生成背面的三角网络，其三角形如下构建：

```plaintext
[
  [(i, j), (i, j+1), (i+1, j)],
  [(i, j+1), (i+1, j+1), (i+1, j)]
]
```

通过以上步骤，可以构建出完整的triangle mesh 3D模型。
### 1.4 Mesh减面技巧

构建好顶点和三角形序列后，进行scale操作，由缩小的尺寸放大到实际需要的尺寸，因为scale操作基本没有耗时，而生成大尺寸的triangle mesh太耗时，所以用这个方法来进行减面操作，可以大大减少生成模型的时间，并保留细节。

#### 三角形构建示例

在构建三角形时，我们需要将顶点连接成三角形。以下是一个示例，展示了如何将顶点连接成三角形：

```
(i, j)    (i, j+1)
   *--------*
   |      / |
   |    /   |
   |  /     |
   *--------*
(bot, j)  (bot, j+1)
```

三角形索引表示为：
\[ [(bot, j), (0, j+1), (0, j)], [(bot, j), (bot, j+1), (0, j+1)] \]

其中，`bot`表示点云图的最后一行。

通过这些步骤，可以有效地构建和优化triangle mesh模型，减少生成时间并保留模型的细节。
### 1.4 Mesh减面技巧

**修正**：从原图构建点云，生成triangle mesh的过程太耗时。原因是由于原图分辨率过大，生成的点云数量较多，构建triangle mesh的过程中需要遍历每个点云来进行三角形序列的构建，计算耗时较大。在这里，我将原图进行一次缩放，构建完triangle mesh后再进行一次scale，缩放回实际需要的大小。因为scale计算复杂度很低，几乎没有耗时，这能使构建triangle mesh的时间比原先缩短10倍，并且由小尺寸的triangle mesh缩放为大尺寸能实现和减面算法相同的减面的效果，生成的stl模型内存大小小时间减少了9倍，并且不必额外付出减面计算消耗的时间和资源。

### 2. 彩色图提取颜色信息

构建完mesh后，需要进行模型分层上色。由于需求是自动生成的“傻瓜式”服务，因此所有的信息都要做到自动化提取。

#### 流程图

```plaintext
输入图片
   ↓
确定聚类个数
   ↓
颜色聚类
   ↓
提取颜色转高度
   ↓
初始化分层点
   ↓
调整分层点
   ↓
输出排序后的颜色及度量range
   ↓
输出最终的分层信息和对应颜色
```

通过以上步骤，可以自动化地提取彩色图的颜色信息，并进行模型的分层上色。
