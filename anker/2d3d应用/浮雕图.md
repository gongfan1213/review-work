### 涉及计算机视觉和3D建模领域中的图像处理和3D模型生成技术，提供了一种利用输入图像自动生成3D浮雕画模型及分层颜色的技术，适用于3D打印机用户个性化创作3D浮雕画，也适用于打印各类艺术浮雕画装饰品的场景。该技术包括以下两个部分：

#### 1. 彩色图像生成Triangle Mesh 3D模型

通过输入彩色图像，自动生成与彩色图纹理细节相同的3D模型。输入一张彩色图进行图像前处理，包括灰度化、缩放、归一化操作。随后，对灰度图进行高度图转换生成点云图并构建Triangle Mesh的Mesh Grid坐标系。最后，生成Triangle Mesh 3D模型，经过模型后处理：缩放模型、翻转三角面法线和旋转模型等技术，保存为stl模型，提供给3D打印机打印。

#### 2. 模型分层信息生成

本部分是对第一部分内容的技术延伸，在获得3D浮雕模型的同时，需要给出分层高度范围和分层颜色。利用肘部法则确定聚类数目，模型高度除以聚类数目得到初始分层高度范围。通过k-means对输入的彩色图进行聚类提取颜色，得到分层颜色信息。随后，对分层颜色进行灰度值化后，计算高度值并按高度从低到高进行排序。最后，调整最开始初始化的分层高度范围，使其将每个颜色分层高度包含在内。

### 具体方案：

#### 一、彩色图像生成Triangle Mesh 3D模型

整体流程如下：

1. **输入彩色图像**：读取输入的彩色图像。
2. **图像前处理**：对图像进行灰度化、缩放和归一化处理。
3. **生成高度图**：将灰度图转换为高度图，表示每个像素点的高度值。
4. **构建点云图**：根据高度图生成点云图，每个点云对应一个3D空间中的顶点。
5. **构建Triangle Mesh**：将点云图中的顶点连接成三角形，生成Triangle Mesh 3D模型。
6. **模型后处理**：对生成的3D模型进行缩放、翻转三角面法线和旋转等处理。
7. **保存模型**：将处理后的3D模型保存为stl格式文件，供3D打印机使用。

#### 二、模型分层信息生成

1. **确定聚类数目**：利用肘部法则确定最佳的聚类数目。
2. **颜色聚类**：使用k-means算法对彩色图进行聚类，提取每个聚类的中心点作为代表颜色。
3. **灰度值化**：将提取的颜色信息转换为灰度值。
4. **计算高度值**：根据灰度值计算每个颜色的高度值，并按高度从低到高进行排序。
5. **调整分层高度范围**：根据初始的分层高度范围，调整每个颜色的分层高度范围，使其包含在内。
6. **输出分层信息**：输出每个分层的高度范围和对应的颜色信息。

通过以上两个部分的技术方案，可以实现从彩色图像到3D浮雕画模型的自动生成，并提供分层颜色信息，适用于3D打印和艺术创作等场景。
### 步骤2：灰度图转高度图

对步骤1处理后得到的灰度图使用高度值转换公式，如公式1.1所示。将灰度信息转换成高度信息后生成点云图，该点云图与步骤1输出的灰度图同尺寸。在公式1.1中，\( H_{\text{max}} \) 和 \( H_{\text{min}} \) 是生成3D模型的最大和最小高度，\( G(i,j) \) 是灰度图 \( (i,j) \) 坐标下的灰度值，\( G_{\text{max}} \) 和 \( G_{\text{min}} \) 分别为当前灰度图最大和最小值。

\[ \text{height} = \left( \frac{H_{\text{max}} - H_{\text{min}}}{G_{\text{max}} - G_{\text{min}}} \right) \times (G(i,j) - G_{\text{min}}) + H_{\text{min}} \quad \text{(公式1.1)} \]

### 步骤3：生成Mesh Grid坐标系

对步骤2生成的点云图进行边界0填充，获得边界为0的点云图。对Mesh Grid坐标系确定坐标单位，本发明明确的模型单位为mm。构建Mesh Grid坐标系时，对x轴坐标，创建一个与点云图同尺寸的数组，以点云图的列数为长度生成等间隔的x轴坐标，x轴坐标每行复制后存储在数组中。同理，对y轴坐标，以点云图的行数为长度，生成等间隔的y轴坐标，y轴坐标每列复制后存储的数组中。Mesh Grid坐标系如图1.1所示，z轴数组存储每个点云的数值，x, y, z三个数组构成Mesh Grid坐标系。

#### 图1.1

```
x1  x2  x3  ...  xcol
x1  x2  x3  ...  xcol
x1  x2  x3  ...  xcol
... ... ... ...  ...
x1  x2  x3  ...  xcol
```

```
y1  y1  y1  ...  y1
y2  y2  y2  ...  y2
y3  y3  y3  ...  y3
... ... ... ...  ...
yrow yrow yrow ... yrow
```

通过以上步骤，可以将灰度图转换为高度图，并生成Mesh Grid坐标系，为后续的3D模型生成和处理打下基础。
### 步骤4：构建Triangle Mesh 3D模型

利用步骤3得到的Mesh Grid坐标系，来构建Triangle Mesh 3D模型。Triangle Mesh是由一组相邻的三角形组成的，每个三角形由三个顶点和它们之间的边构成。其主要属性包括顶点坐标和三角形索引。

- **顶点坐标**：是一个二维数组，每一行包含三维空间中的一个顶点的坐标。
- **三角形索引**：是一个二维数组，每一行包含一个三角形的三个顶点索引，这些索引对应于顶点坐标。

遍历meshgrid坐标系，每个(i, j)坐标生成六个顶点，构成两个三角形来构建模型表面。构建完整模型表面，需要对模型背面进行构建。每个(i, j)坐标与构建模型表面同理，生成六个顶点并构成两个三角形来构建模型背面。

#### Mesh Grid坐标系下的三角形构建

图1.2展示了模型表面的三角形索引构建方式，图1.3展示了模型背面的三角形索引的构建方式。以顶点(i, j)为例，模型表面的三角形索引构建为(i, j), (i, j+1), (i+1, j)三个顶点构建另一个三角形。模型背面的三角形构建为(bot, j), (0, j+1), (0, j)三个顶点构建一个三角形，(bot, j), (bot, j+1), (0, j+1)三个顶点构建另一个三角形，bot表示x轴坐标最后一行。

#### 图1.2

```
(i, j)    (i, j+1)
   *--------*
   |      / |
   |    /   |
   |  /     |
   *--------*
(i+1, j)  (i+1, j+1)
```

三角形索引表示为：
\[ [(i, j), (i, j+1), (i+1, j)], [(i, j+1), (i+1, j+1), (i+1, j)] \]

通过以上步骤，可以利用Mesh Grid坐标系构建Triangle Mesh 3D模型，生成完整的三维模型表面。
### 步骤5：3D模型后处理

对步骤4生成的Triangle Mesh 3D模型经过模型后处理操作，生成可以让3D打印机切片打印的stl模型。主要的模型后处理包括：减面、法线反转和旋转操作。

- **减面**：对于减面操作，从原图构建点云，生成Triangle Mesh的过程太耗时，由于原图分辨率过大，生成的点云数量较多，构建Triangle Mesh的过程需要遍历每个点云来进行三角形序列的构建，计算耗时较大。在这里，本发明将原图进行一次缩放，构建完Triangle Mesh后再进行一次缩放，使其缩放回实际需要的大小。因为缩放操作计算复杂度较低，几乎没有耗时，这能使构建Triangle Mesh的时间比原先缩短10倍，并且由小尺寸的Triangle Mesh缩放为大尺寸能实现和3D模型减面算法相同的减面效果，生成的stl模型内存大小小时间减少了9倍，并且不必额外付出减面计算消耗的时间和资源。
- **法线反转**：将法线进行反转，这适用于操作的光照及光线效果，让用户能观察到清晰的模型表面纹理。
- **旋转**：由于构建Triangle Mesh的过程是倒叙遍历彩色图像素，在生成最终的3D模型时，需要将模型旋转回正常视角。

最后，将经过后处理的模型保存为3D打印的通用格式——stl。

### 二、模型分层信息生成

本方案是对方案一的补充，3D打印机要呈现原图的色彩风格，需要用不同颜色的耗材进行分层打印，算法方案要输出分层信息来指导3D打印机进行暂停换料操作。

#### 整体流程如下：

```plaintext
输入彩色图 → 肘部法则确定聚类个数 → k-means提取颜色 → 分层颜色转高度并排序 → 输出排序后的分层信息
   ↓
初始化分层点 → 调整分层点 → 切片层数转换 → 输出分层信息
```

#### 步骤：

1. **肘部法则确定聚类数目**：使用肘部法则来确定颜色聚类数目，该聚类数目也是分层数。肘部法则是一种在聚类算法中确定最佳聚类数目的启发式方法，这种方法的核心思想是探索数据中聚类的数量与每个点到其聚类中心的平均距离之间的关系。计算步骤可分为：
   - 计算误差值：对于k-means聚类，该值通常是WCSS（Within-Cluster-Sum-of-Squares），即每个值与聚类质心的偏差平方和。
   - 多次运行聚类算法：使用k=1,2,3,...,n作为要尝试的聚类数量，并为每个k值计算上述误差。
   - 画出误差值：使用一个线性图来表示不同k值对应的误差值。
   - 查找“肘”点：随着聚类数量的增加，误差值通常会减少。这是因为，当有更多的簇时，每个簇中的数据点更贴近其中心。然而，误差值的减少速率在某一点会大大减缓。这个点被称为“肘”，它对应的k值就是最佳的聚类数量。

2. **k-means提取颜色**：使用k-means算法对彩色图进行聚类，提取每个聚类的中心点作为代表颜色。

3. **分层颜色转高度并排序**：将提取的颜色信息转换为灰度值，根据灰度值计算每个颜色的高度值，并按高度从低到高进行排序。

4. **输出排序后的分层信息**：输出每个分层的高度范围和对应的颜色信息。

5. **初始化分层点**：根据初始的分层高度范围，初始化每个分层点。

6. **调整分层点**：调整每个分层点的高度范围，使其包含在内。

7. **切片层数转换**：将分层信息转换为3D打印机的切片层数。

8. **输出分层信息**：最终输出每个分层的高度范围和对应的颜色信息，指导3D打印机进行暂停换料操作。

通过以上步骤，可以实现从彩色图像到3D浮雕画模型的自动生成，并提供分层颜色信息，适用于3D打印和艺术创作等场景。
### 步骤1：使用肘部法则来确定颜色聚类数目

该聚类数目也是分层数。肘部法则是一种在聚类算法中确定最佳聚类数目的启发式方法，这种方法的核心思想是探索数据中聚类的数量与每个点到其聚类中心的平均距离之间的关系。

#### 计算步骤：

1. **计算误差值**：计算聚类后每个值与聚类质心的偏差平方和，该值通常称为WCSS（Within-Cluster-Sum-of-Squares）。对于每个点计算它到其分配的中心的距离的平方，然后将所有的距离平方相加。

2. **多次运行k-means聚类算法**：使用k=1,2,3,...,n作为要尝试的聚类数量，并为每个k值计算上述误差。在本发明中，的数量定义为10。

3. **列出每个聚类数量的误差值**：画出误差曲线，如图2.1所示。当误差值的减少速率在某一点会大大减缓时，这就是“肘”点，它对应的k值就是最佳的聚类数量。通过连接首尾聚类点，将连线距离设置为阈值，之后依次计算剩余点和首尾点的连线距离合，输出连线距离合最大的点，该点的值就是聚类数量。

#### 图2.1

![Elbow Method](https://i.imgur.com/4Y5Q5QG.png)

通过以上步骤，可以使用肘部法则确定颜色聚类数目，从而为后续的颜色提取和分层操作提供依据。
