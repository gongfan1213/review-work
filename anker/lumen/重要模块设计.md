# 项目实时保存
### 实时保存内容
- 1.图层json
- 2.缩略图
- 1.1创建项目
- 2 - 编辑project
- 2.1- 模版里面的图片
- 2.2- 官方或者个人元素里面的图片
- 2.3- 用户本地导入
- 3. 每隔3s判断图层json里是否有修改->false不操作
- 4.队列任务没有完成等待下次上传
- 5- 第一种情况是获取画布缩略图-》上传缩略图
- 5- 第二种情况-执行任务，判断是否存在没有上传的image-〉true上传图片替换srcbase 64.然后上传json，
- 5.2- false的话上传json，上传新增的key，修改画布里面的src

#### 图片添加入口
- 1.模版里面的图片，上传设置类型1018
- 2.官方/个人元素里面的图片base64导入
- 3.用户本地导入，上传设置类型1019
#### 判断是否需要上传
- 1.类型是图片
- 2.base64
- 3.本地缓存上传过的图片(updatetoke前缀：本地导入和模版里面的图片，http前缀:元素里面的图片，)
- ps:每次添加，删除图片调用更新项目的接口

# 2.图片渲染的跨域问题
- 同源策略same-origin policy是一个浏览器的安全机制，用于限制不同源之间的跨域操作，他是一种控制浏览器如何处理来自不同源的资源，例如文档，脚本，样式表和ajax请求的规则
- 在同源策略当中，如果两个url具有相同的协议protocol主机host和端口号port，则视为同源origin
- 一个域名地址的组合
- https://协议,www.api子域名,.jincou.com域名:8080端口号，/index.html请求路径
- 四个只要有一个不同就构成了跨域
- eg
- 当一个浏览器的两个tab页当中分别打开来自百度和谷歌的页面，浏览器的百度tag页执行一个脚本的时候回检查这个脚本是属于哪个页面的，就是检查是否同源的，只有和百度同源的脚本才会被执行，如果不是同源的，那么在请求数据的时候，浏览器在控制台当中爆出一个异常，提示拒绝访问的
- 注意：跨域并不是请求发不出去，而是请求能发出去而服务器能收到请求并且正常返回结果，只是结果被浏览器拦截
#### 怎么加载跨域图片
- 图像服务器必须设置cors跨域资源共享响应头，允许你的域名访问图像资源
- 在前端代码当中，当创建img标签或者使用image/canvas对象加载图像的时候，需要设置crossOrigin属性为anonymous这高速浏览器在请求图像的时候不发送用户凭证
- 项目问题，选择画布当中可以加载画布底层，但是在canvas当中加载不了底层，报错画布图片的跨域，当前并不支持
- img：用于在网页上显示图像，浏览器允许你使用img标签从任何来源加载图像，即使是跨域的，这是因为图像本身不会泄漏源信息，并且图像的使用被认为是低风险的
- canvas元素：用于图像的绘制和图像的处理，当你试图在canvas上使用跨域图像数据的时候，同源策略会生效的，如果canvas会操作设计到跨域数据，浏览器会将其标记为脏，并且限制对图像数据的进一步的访问，这是因为canvas可以用来读取和操作图像数据的
- 可能会泄漏敏感信息因此需要更严格的安全错误
- 3.在项目当中的selectdialog加载画布，直接使用img标签加载，这个时候img并没有没有设置crossOrigin属性，但是因为img标签不受同源策略限制的，可以正常加载的，然后canvas去加载同一张图片，这个时候从缓存当中获取，缓存当中的数据并没有corssOrigin属性，所以canvas加载失败的，报错同源限制的
- 修改的时候，在img标签都设置crossOrigin属性anonymous，同时注意如果canvas单独使用到的img图片，需要添加crossOrigin属性
# 3.nodejs生成项目文件
- 在浏览器点击print，执行几个动作
- 上传打印效果
- 获取非标品长和宽并且上传
- 生成tar包并且上传
- 这些操作移植到nodejs里面存在一个问题，生成tar包比较耗时



- 手机壳+1张图片，下载时长80ms
- 手机壳+10张图片,下载时长600ms

- 主要问题是耗时过长，主要耗时是渲染和生图
- 渲染师调用fabric官方的api方法loadJson方法，这块暂时没有办法优化的，在nodejs时间长，原因是只能调用cpu渲染，无法gpu加速，gpu加速需要预研，但是当前是没有预算的
- 为了获取结果
- 1.上传打印效果图-浏览器每5s获取上传，缩略图上传取消
- 2.获取非标品长宽并且上传，浏览器每5s获取上传
- 3.生成tar包并且上传-后台生成客户端调用不可见的浏览器生成

- 根据以上数据显示的，在后台做生成tar包处理速度太慢了，建议在调用浏览器方法实现上传
- web端每5s上传缩略图修改为每5s上传效果图，同时上传非标长和宽，使用缩略图链接
- web端新建一个页面，提供生成tar包的方法
- 建议客户端在发起打印之前，调用隐藏的web页面，生产targ包
# 4.2d编辑器性能优化项目
## 画布实时保存，相同的图片节流保存
- 当前画布的数据当中的图片添加包括以下的路径
- 1.ai生成图
- 2.上传图片
- 3.元素图片，通过元素的key_prefix作为唯一的key，添加的时候导入的
- 4.模版图片，可以通过模版本身图片的key_prefix作为唯一的key，如果上传过，不用上传
- 元素图片和模版图片的添加是可以优化的，采用相同的图片节流方式节省流量的使用
## 官方素材刘表接口和状态接口的合并
- 当前方法，当前获取结果需要调用n+1个接口数量，拉去图片和文字模版列表-》获取分类->每个分类从cms获取图片/文字模版列表->拿到id列表，从后台获取收藏列表状态+元素文件链接
- 优化方法:获取结果需要调用n个接口
- 拉去图片和文字模版列表->获取分类->每个分类从后台获取图片/文字模版列表，其中包含了收藏状态+元素文件链接的
## 个人云空间，图片上传需要上传缩略图，个人ai历史图片，需要添加缩略图
- 1.上传个人空间web端可以上传两次，一次上传缩略图，然后上传原图，然后调用上传接口，这块接口需要改动的
- 个人ai历史图片，这块后台应该可以处理的，生图生成自动添加到个人的理智，同时需要压缩获取缩略构图，web端的历史列表显示需要修改的
## 2d编辑器图片元素过多卡顿的问题
### 1.canvas.on添加了画布监听，但是使用完没有使用canvas.off注销掉的
#### 2d编辑器编辑undo，redo历史保存
- 当前每一步都是保存完整的画布的数据，比如每一步新一张1m图片，10步就会有55m的缓存数据，这里有45m的多余的数据
- 开启保存->编辑修改监听-》保存当前画布的数据完整的
- 读取历史的-〉读取具体哪一步的完整的数据
## 当前每一步都是保存新增的数据，需要业务端手动添加，比如每一步新增1张1m图片，10步就会有10m的缓存
- 开启保存->业务需求出发，手动添加，触发保存->新建保存对象，每一步保存该步骤的redo，undo方法，->把历史对象添加到队列当中
- 读取历史->读取具体位置之前所有的undo或者redo操作->把历史对象添加到队列当中
- 总结：先使用保存到本地的方法，如果图片保存到本地或者只在缓存保存最近的三步
# web创作平台数据保护方案
## 需要保护的官方资源
- 1.图片元素，文字和模版是直接导入canvas的，所以在控制台是看不到具体元素信息
- 2.ai图片
- 3.ai模型
## 官方资源用户可以查看的场景
- 1.图片的下载
- 涉及到的具体的场景
- 1.官方元素点击加载到画布
- 2.生产ai图片返回加载到的画布
- 1.Image设置src，包括base64和url
- const img=newImage（）；
- img.src=src
- 2.fetch下载图片
- await fetch(url)
- 解决方案
- cms导入图片->根据压缩策略得到图片的缩略图->加密原图的到加密后的文件，并且压缩成zip->上传s3-》同步添加元素表数据
- 2d编辑器查看元素->显示缩略图列表->点击元素->下载压缩图zip包->加密和解密文件->添加到画布
- Image设置问题web端替换，使用canvas绘制的，可以规避在控制看查看到图片的原始数据的问题
## 2.ai模型的本地保存
- cms导入模型文件->加密文件的到加密后的文件，并且压缩成zip-》上传s3-〉修改文件版本->发布数据
- 创作平台->用户使用本地ai-》是否需要下载ai模块——〉是的话下载压缩图zip包，保存到本地-》保存数据库，模型类型/模型版本->解压和解密文件->导入onnx
- ai模型的版本管理
- 在web端使用本地的ai模型，web端获取该模型对应的版本信息，cms本地比对版本的状态
- web端根据版本号判断是否更新

### 3.加密方案
- aes方法
- web端本地保存aes密钥，获取文件进行aes解密
- cmsaes加密文件
- dech方法
- web端生成公私钥，本地保存私跃，cms上传脚本使用固定的公钥，生成公私钥
- cms生成共享密钥加密文件，上传文件和公钥
- web端获取文件和公钥，生产共享密钥解密
- 这两个方案耗时情况，都是aes解密时长，100ms的数据大约需要0.2秒，10ms的数据大约需要0.02秒，对整体交互性影响不大的
### 常见问题
- ssr构建问题,fabric.js依赖于浏览器的canvasapi，而且在服务器端环境当中这些api是不可以用的，所以在使用到fabric的引入导入的时候，需要在代码当中动态的导入的
### qa环境和pc调试的设置
- 因为pc要访问ip才能进入调试的，但是如果访问ip调试，登陆的时候调用window.crypto.subtle会出现错误，导致无法登陆，为了解决这个问题，需要项目支持https域名访问，针对这个问题，需要的操作步骤如下
- 配置
- 项目目录下的cert/server.cert文件需要添加到钥匙串当中，并且完全信任
- 配置host，给ip设置对应的域名
- sudo nano /etc/hosts
- 10.1.121.224 my-local-domain。com
- 配置pc访问路径，修改Ankerconfig。ini文件
- cd ~/Library?application/Support?ankerMake/Studio?profile
- open ./
- qa调试的话，需要修改baseurl为qa的域名
- export const baseUrl=（（）=》{return 'https://aiot-wapi-qa.xxxxxx.com
- 开始调试，执行yarn debelopPc开启本地服务

